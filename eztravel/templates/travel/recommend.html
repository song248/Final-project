{% extends 'travel/index.html' %}

{% block content %}
{% load static %}
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <script src="https://apis.openapi.sk.com/tmap/jsv2?version=1&appKey=l7xx0bc558171c774e4ba754afa0476b3077"></script>
    <script	src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script type="text/javascript">
    
        var map;
        var markers = [];

        var rec_route = '{{ rec_route }}'.replaceAll('&#x27;', '').replace('[','').replace(']', '').split(',')
        var new_rec_route=[];
        for (var i=0;i<rec_route.length;i++) { new_rec_route.push(rec_route[i].trim()) } // ê¸€ì ì• ì¢Œìš° ê³µë°±ì„ ì œê±°
        rec_route = new_rec_route;

        var route_y = JSON.parse('{{ y }}');
        var route_x = JSON.parse('{{ x }}');

        // ì‚¬ì „        
        point_location = {};
        for (var i=0;i<rec_route.length;i++) {
            point_location[rec_route[i]] = [route_y[i], route_x[i]]
        }
        console.log('point_location', point_location);
        
        function initTmap(){        
            // map ìƒì„±
            map = new Tmapv2.Map("map_div", {
                center: new Tmapv2.LatLng(36.4, 127.9), // ì§€ë„ ì´ˆê¸° ì¢Œí‘œ
                zoom: 8, // ì§€ë„ í™•ëŒ€
                zoomControl:true,
                scrollwheel:true,
                width: "900px", // mapì˜ width ì„¤ì •
                height: "800px" // mapì˜ height ì„¤ì •
                });


            addMarker(rec_route);
            console.log(rec_route, point_location);
            var distance = get_distance(rec_route, point_location); // Aì—ì„œ Bê¹Œì§€ì˜ ëª¨ë“  ê±°ë¦¬
            console.log('distance', distance);

            var all_route = getPermutations(rec_route, rec_route.length);
            console.log('all_route', all_route);
            
            var route_distance = get_route_distance(all_route, distance);
            console.log('route_distance', route_distance);
            
            var shortest_route = get_shortest_route(route_distance);
            console.log('shortest_route', shortest_route); // ìµœì¢… ê²°ê³¼!
            
            moveCenter(point_location[shortest_route[0][0]][0], point_location[shortest_route[0][0]][1])

            var how_route = "";
			var route_order = shortest_route[0][0];
			for (var i=1;i<shortest_route[0].length;i++) {
                route_order += '<br>';
				route_order += 'â†“<br>';
				route_order += shortest_route[0][i];
			}
			how_route = route_order
            $('#how_route').html(how_route)

            $('#how_km').html("<span>&nbsp&nbspğŸ”¹ì´ ê±°ë¦¬: &nbsp"+shortest_route[1].toFixed(2)+"km</span>")

            // ì„  ê·¸ë ¤ì£¼ê¸°
			for (var i=0;i<shortest_route[0].length-1;i++) {
				var drawInfoArr = [];
				$.ajax({
					type : "POST",
					url : "https://apis.openapi.sk.com/tmap/routes?version=1&format=json&callback=result",
					async : false,
					data : {
						"appKey" : "l7xx0bc558171c774e4ba754afa0476b3077",
						"startX" : String(point_location[shortest_route[0][i]][1]),
						"startY" : String(point_location[shortest_route[0][i]][0]),
						"endX" : String(point_location[shortest_route[0][i+1]][1]),
						"endY" : String(point_location[shortest_route[0][i+1]][0]),
						"reqCoordType" : "WGS84GEO",
						"resCoordType" : "EPSG3857",
					},
					success : function(response) {
						var resultData = response.features;

						for (var rd in resultData) { 
							var geometry = resultData[rd].geometry;
							
							if (geometry.type == "LineString") {
								for ( var j in geometry.coordinates) {
                                    
									// ê²½ë¡œë“¤ì˜ ê²°ê³¼ê°’ë“¤ì„ í¬ì¸íŠ¸ ê°ì²´ë¡œ ë³€í™˜ 
									var latlng = new Tmapv2.Point(
											geometry.coordinates[j][0],
                                            geometry.coordinates[j][1]);
                                    
									// í¬ì¸íŠ¸ ê°ì²´ë¥¼ ë°›ì•„ ì¢Œí‘œê°’ìœ¼ë¡œ ë³€í™˜
									var convertPoint = new Tmapv2.Projection.convertEPSG3857ToWGS84GEO(latlng);
                                            
									// í¬ì¸íŠ¸ê°ì²´ì˜ ì •ë³´ë¡œ ì¢Œí‘œê°’ ë³€í™˜ ê°ì²´ë¡œ ì €ì¥
									var convertChange = new Tmapv2.LatLng(
											convertPoint._lat,
                                            convertPoint._lng);
                                            
									// ë°°ì—´ì— ë‹´ê¸°
                                    drawInfoArr.push(convertChange);
                                    
								}
								drawLine(drawInfoArr, i);
                                sleep(500);
							}
						}
					},
					beforeSend:function(){
						console.log('beforesend')
					},
				});
			}
        }

        // ì‹œê°„ì´ì—¬ ë©ˆì¶°ë¼!!
        function sleep(ms){
            ts1 = new Date().getTime() + ms;
            do ts2 = new Date().getTime(); while (ts2<ts1);
        }

            
        function addMarker(rec_route) {
            for (var i=0;i<rec_route.length;i++) {
                var marker = new Tmapv2.Marker({
                    position: new Tmapv2.LatLng(point_location[rec_route[i]][0], point_location[rec_route[i]][1]),
                    icon: "http://tmapapis.sktelecom.com/upload/tmap/marker/pin_b_m_"+ i +".png",
                    iconSize: new Tmapv2.Size(30, 45),
                    label: rec_route[i],
                    fontColor: 'black'
                });
                marker.setMap(map);
            }
        }        
        
        function moveCenter(y, x) {
            var newCenter = new Tmapv2.LatLng(y, x)
            map.setCenter(newCenter);
            map.setZoom(12); // í™•ëŒ€ í¬ê¸°
        }
    
        const getPermutations= function (arr, selectNumber) {
            const results = [];
            if (selectNumber === 1) return arr.map((value) => [value]); // 1ê°œì”© íƒí•  ë•Œ, ë°”ë¡œ ëª¨ë“  ë°°ì—´ì˜ ì›ì†Œ return

            arr.forEach((fixed, index, origin) => {
                const rest = [...origin.slice(0, index), ...origin.slice(index+1)] // í•´ë‹¹í•˜ëŠ” fixedë¥¼ ì œì™¸í•œ ë‚˜ë¨¸ì§€ ë°°ì—´ 
                const permutations = getPermutations(rest, selectNumber - 1); // ë‚˜ë¨¸ì§€ì— ëŒ€í•´ ìˆœì—´ì„ êµ¬í•œë‹¤.
                const attached = permutations.map((permutation) => [fixed, ...permutation]); // ëŒì•„ì˜¨ ìˆœì—´ì— ëŒ€í•´ ë–¼ ë†“ì€(fixed) ê°’ ë¶™ì´ê¸°
                results.push(...attached); // ë°°ì—´ spread syntax ë¡œ ëª¨ë‘ë‹¤ push
            });
            return results; // ê²°ê³¼ ë‹´ê¸´ results return
        };
        
        function get_distance(rec_route, point_location) {
            var p_to_p = {};
            console.log(rec_route)
            for (var i=0;i<rec_route.length-1;i++) {
                for (var j=i+1;j<rec_route.length;j++) {
                    console.log(rec_route[i], rec_route[j])
                    // ì¥ì†Œì™€ ì¥ì†Œê°„ì˜ ê±°ë¦¬ ê³„ì‚°
                    $.ajax({
                        type : "POST",
                        url : "https://apis.openapi.sk.com/tmap/routes?version=1&format=json&callback=result",
                        async : false, // ajax ë¥¼ ëŒë¦´ ë–„ ìˆœì°¨ì ìœ¼ë¡œ ëŒ ìˆ˜ ìˆë„ë¡ í•˜ê¸° ìœ„í•´ì„œ
                        data : {
                            "appKey" : "l7xx0bc558171c774e4ba754afa0476b3077",
                            "startX" : String(point_location[rec_route[i]][1]),
                            "startY" : String(point_location[rec_route[i]][0]),
                            "endX" : String(point_location[rec_route[j]][1]),
                            "endY" : String(point_location[rec_route[j]][0]),
                            "reqCoordType" : "WGS84GEO",
                            "resCoordType" : "EPSG3857"
                        },
                        success:function(response){
                            var resultData = response.features;
                            var distance = (resultData[0].properties.totalDistance / 1000)

                            p_to_p[rec_route[i] +','+ rec_route[j]] = Number(distance);
                            p_to_p[rec_route[j] +','+ rec_route[i]] = Number(distance);
                        }
                    });                    
                    sleep(500); // 1ì´ˆ
                }
            }
            return p_to_p
        }

        function get_route_distance(all_route, distance) {
            var rec_route_list = [];

			for (var i=0; i<all_route.length;i++) {
				var len_point_routes = 0;

				for (var j=0; j<all_route[i].length-1;j++) {
					var atob = all_route[i][j] +','+ all_route[i][j+1]
					var len_point_route = distance[atob]
					len_point_routes += len_point_route
				}
				rec_route_list.push([all_route[i], len_point_routes])
            }
            return rec_route_list
        }

        function get_shortest_route(route_distance) {
            var shortest_route=['', 1000000000000000000]; // ì €ì¥í•˜ê¸° ìš©
			for (var i in route_distance) {
				if (route_distance[i][1] < shortest_route[1]) {
					shortest_route = route_distance[i]
				}
            }
            return shortest_route
        }

        function drawLine(arrPoint, num) {
            var resultdrawArr = []
            var polyline_;
            var lineColor="";
        
            if (num % 7 == 0) { lineColor='#ff0000' }
            else if (num % 7 == 1) { lineColor='#f06200' }
            else if (num % 7 == 2) { lineColor='#f0f300' }
            else if (num % 7 == 3) { lineColor='#00ff00' }
            else if (num % 7 == 4) { lineColor='#0000ff' }
            else if (num % 7 == 5) { lineColor='#000074' }
            else if (num % 7 == 6) { lineColor='#970cda' }
            
            //ë¼ì¸ê·¸ë¦¬ê¸°[S]
            polyline_ = new Tmapv2.Polyline({
                path : arrPoint,
                strokeColor : lineColor,
                strokeWeight : 6,
                map : map
            });
            resultdrawArr.push(polyline_);
        }
    </script>
</head>

<body onload="initTmap()">
    <div id="first_table">
		<center><table border='0' bgcolor="#444444">
            <tr>
                <td rowspan="4">
                    <div id="map_div" style="color:black;"></div>
                </td>
                <td>
                    <span></span>
                </td>
            </tr>
            <tr>
                <td style="width:250px;">
                    <center>
                        <p><br><span style="font-size:150%;">ì¶”ì²œ ê´€ê´‘ì½”ìŠ¤<span style="font-size:180%;">ğŸš™</span></p><br>
                        <p style="font-size:130%;" id='how_route'></p>
                    </center>    
                </td>
            </tr>
            <tr>
                <td><center><br><br>
                    <p style="font-size:130%;" id='how_km'></p>
                </center></td>
            </tr>
            <tr>
                <td style="height: 380px;">
                <span></span></td>
            </tr>
        </table></center>
    </div>
</body>
{% endblock %}